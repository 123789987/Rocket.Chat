kind: pipeline
name: default

steps:
- name: build
  image: ubuntu:18.04
  # environment:
  #   -
  commands:
    - apt update && apt install curl git python g++ build-essential bzip2 -y
    - export HOME=/drone
    - export PATH="/drone/.meteor:$PATH"
    - if [ ! -e "/drone/.meteor/meteor" ]; then export HOME=/drone; curl https://install.meteor.com | sed s/--progress-bar/-sL/g | /bin/sh; fi
    - which meteor
    - meteor npm install
    - mkdir /drone/build
    - meteor build --server-only --directory /drone/build
    # - cp .docker/Dockerfile.local /drone/build/Dockerfile

- name: Versions
  commands:
    # - npm --versions
    # - node -v
    - meteor --version
    - meteor npm --versions
    - meteor node -v
    - git version

# rebuild-cache:
#   image: drillster/drone-volume-cache
#   rebuild: true
#   mount:
#     - /drone/.meteor/
#     - ./node_modules
#     - ./.meteor/local
#   volumes:
#     - /tmp/cache/Rocket.Chat:/cache

# docker:
#   image: plugins/docker
#   repo: rocketchat/rocket.chat
#   dockerfile: /drone/build/Dockerfile
#   storage_driver: overlay
#   context: /drone/build
#   secrets: [ docker_username, docker_password ]
#   tag: designpreview
